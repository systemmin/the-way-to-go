import{_ as l,c as i,a as o,b as a,f as s,d as p,e,r as c,o as u}from"./app-DtITwm2S.js";const r={};function d(k,n){const t=c("RouteLink");return u(),i("div",null,[n[28]||(n[28]=o(`<h1 id="版本-3-添加协程" tabindex="-1"><a class="header-anchor" href="#版本-3-添加协程"><span>版本 3 - 添加协程</span></a></h1><p>第 3 个版本的代码 <em>goto_v3</em> 见 <a href="examples/chapter_19/goto_v3">goto_v3</a>。</p><h1 id="_19-6-用协程优化性能" tabindex="-1"><a class="header-anchor" href="#_19-6-用协程优化性能"><span>19.6 用协程优化性能</span></a></h1><p>如果有太多客户端同时尝试添加 URL，第 2 个版本依旧存在性能问题。得益于锁机制，我们的 <code>map</code> 可以在并发访问环境下安全地更新，但每条新产生的记录都要立即写入磁盘，这种机制成为了瓶颈。写入操作可能同时发生，根据不同操作系统的特性，可能会产生数据损坏。就算不产生写入冲突，每个客户端在 <code>Put()</code> 函数返回前，必须等待数据写入磁盘。因此，在一个 I/O 负载很高的系统中，客户端为了完成 <code>Add()</code> 请求，将等待更长的不必要的时间。</p><p>为缓解该问题，必须对 <code>Put()</code> 和存储进程<em>解耦</em>：我们将使用 Go 的并发机制。我们不再将记录直接写入磁盘，而是发送到一个<em>通道</em>中，它是某种形式的缓冲区，因而发送函数不必等待它完成。</p><p>保存进程会从该通道读取数据并写入磁盘。它是以 <code>saveLoop()</code> 协程启动的独立线程。现在 <code>main()</code> 和 <code>saveLoop()</code> 并行地执行，不会再发生阻塞。</p><p>将 <code>URLStore</code> 的 <code>file</code> 字段替换为 <code>record</code> 类型的通道：<code>save chan record</code>。</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">type</span> URLStore <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	urls <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">	mu sync<span class="token punctuation">.</span>RWMutex</span>
<span class="line">	save <span class="token keyword">chan</span> record</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通道和 <code>map</code> 一样，必须用 <code>make()</code> 创建。我们会以此修改 <code>NewURLStore()</code> 工厂函数，并给定缓冲区大小为 1000，例如：<code>save := make(chan record, saveQueueLength)</code>。为解决性能问题，<code>Put</code> 可以发送记录 <code>record</code> 到带缓冲的 <code>save</code> 通道：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>URLStore<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">		key <span class="token operator">:=</span> <span class="token function">genKey</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			s<span class="token punctuation">.</span>save <span class="token operator">&lt;-</span> record<span class="token punctuation">{</span>key<span class="token punctuation">,</span> url<span class="token punctuation">}</span></span>
<span class="line">			<span class="token keyword">return</span> key</span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;shouldn&#39;t get here&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>save</code> 通道的另一端必须有一个接收者：新的 <code>saveLoop()</code> 方法在独立的协程中运行，它接收 <code>record</code> 值并将它们写入到文件。<code>saveLoop()</code> 是在 <code>NewURLStore()</code> 函数中用 <code>go</code> 关键字启动的。现在，可以移除不必要的打开文件的代码。以下是修改后的 <code>NewURLStore()</code>：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">const</span> saveQueueLength <span class="token operator">=</span> <span class="token number">1000</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewURLStore</span><span class="token punctuation">(</span>filename <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>URLStore <span class="token punctuation">{</span></span>
<span class="line">	s <span class="token operator">:=</span> <span class="token operator">&amp;</span>URLStore<span class="token punctuation">{</span></span>
<span class="line">		urls<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">		save<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> record<span class="token punctuation">,</span> saveQueueLength<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Error loading URLStore:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">go</span> s<span class="token punctuation">.</span><span class="token function">saveLoop</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">return</span> s</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以下是 <code>saveLoop()</code> 方法的代码：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>URLStore<span class="token punctuation">)</span> <span class="token function">saveLoop</span><span class="token punctuation">(</span>filename <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_APPEND<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;URLStore:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	e <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// taking a record from the channel and encoding it</span></span>
<span class="line">		r <span class="token operator">:=</span> <span class="token operator">&lt;-</span>s<span class="token punctuation">.</span>save</span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;URLStore:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在无限循环中，记录从 <code>save</code> 通道读取，然后编码到文件中。</p>`,15)),a("p",null,[n[1]||(n[1]=s("我们在 ")),p(t,{to:"/chapter-4/14.0.html"},{default:e(()=>n[0]||(n[0]=[s("14 章")])),_:1}),n[2]||(n[2]=s(" 深入学习了协程和通道，但在这里我们见到了实用的案例，更好地管理程序的不同部分。注意现在 ")),n[3]||(n[3]=a("code",null,"Encoder",-1)),n[4]||(n[4]=s(" 对象只被创建一次，而不是每次保存时都创建，这也可以节省了一些内存和运算处理。"))]),a("p",null,[n[6]||(n[6]=s("还有一个改进可以使 goto 更灵活：我们可以将文件名、监听地址和主机名定义为标志 (flag)，来代替在程序中硬编码或定义常量。这样当程序启动时，可以在命令行中指定它们的新值，如果没有指定，将采用 flag 的默认值。该功能来自另一个包，所以需要 ")),n[7]||(n[7]=a("code",null,'import "flag"',-1)),n[8]||(n[8]=s("（这个包的更详细信息见 ")),p(t,{to:"/chapter-4/12.4.html"},{default:e(()=>n[5]||(n[5]=[s("12.4 节")])),_:1}),n[9]||(n[9]=s("）。"))]),n[29]||(n[29]=o(`<p>先创建一些全局变量来保存 flag 的值：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">var</span> <span class="token punctuation">(</span></span>
<span class="line">	listenAddr <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:8080&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http listen address&quot;</span><span class="token punctuation">)</span></span>
<span class="line">	dataFile <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;store.gob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data store file name&quot;</span><span class="token punctuation">)</span></span>
<span class="line">	hostname <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:8080&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;host name and port&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2)),a("p",null,[n[11]||(n[11]=s("为了处理命令行参数，必须把 ")),n[12]||(n[12]=a("code",null,"flag.Parse()",-1)),n[13]||(n[13]=s(" 添加到 ")),n[14]||(n[14]=a("code",null,"main()",-1)),n[15]||(n[15]=s(" 函数中，在 flag 解析后才能实例化 ")),n[16]||(n[16]=a("code",null,"URLStore",-1)),n[17]||(n[17]=s("，一旦得知了 ")),n[18]||(n[18]=a("code",null,"dataFile",-1)),n[19]||(n[19]=s(" 的值（在代码中使用了 ")),n[20]||(n[20]=a("code",null,"*dataFile",-1)),n[21]||(n[21]=s("，因为 flag 是指针类型必须解除引用来获取值，见 ")),p(t,{to:"/chapter-4/04.9.html"},{default:e(()=>n[10]||(n[10]=[s("4.9 节")])),_:1}),n[22]||(n[22]=s("）："))]),n[30]||(n[30]=o(`<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">var</span> store <span class="token operator">*</span>URLStore</span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	store <span class="token operator">=</span> <span class="token function">NewURLStore</span><span class="token punctuation">(</span><span class="token operator">*</span>dataFile<span class="token punctuation">)</span></span>
<span class="line">	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> Redirect<span class="token punctuation">)</span></span>
<span class="line">	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">,</span> Add<span class="token punctuation">)</span></span>
<span class="line">	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token operator">*</span>listenAddr<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在 <code>Add()</code> 处理函数中须用 <code>*hostname</code> 替换 <code>localhost:8080</code>：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line">fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;http://%s/%s&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> key<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>编译或直接使用现有的可执行程序测试第 3 个版本。</p><h2 id="链接" tabindex="-1"><a class="header-anchor" href="#链接"><span>链接</span></a></h2>`,5)),a("ul",null,[a("li",null,[p(t,{to:"/chapter-4/directory.html"},{default:e(()=>n[23]||(n[23]=[s("目录")])),_:1})]),a("li",null,[n[25]||(n[25]=s("上一节：")),p(t,{to:"/chapter-4/19.5.html"},{default:e(()=>n[24]||(n[24]=[s("持久化存储：gob")])),_:1})]),a("li",null,[n[27]||(n[27]=s("下一节：")),p(t,{to:"/chapter-4/19.7.html"},{default:e(()=>n[26]||(n[26]=[s("以 json 格式存储")])),_:1})])])])}const m=l(r,[["render",d],["__file","19.6.html.vue"]]),g=JSON.parse('{"path":"/chapter-4/19.6.html","title":"版本 3 - 添加协程","lang":"zh-cn","frontmatter":{},"headers":[{"level":1,"title":"版本 3 - 添加协程","slug":"版本-3-添加协程","link":"#版本-3-添加协程","children":[]},{"level":1,"title":"19.6 用协程优化性能","slug":"_19-6-用协程优化性能","link":"#_19-6-用协程优化性能","children":[{"level":2,"title":"链接","slug":"链接","link":"#链接","children":[]}]}],"git":{},"filePathRelative":"chapter-4/19.6.md"}');export{m as comp,g as data};
