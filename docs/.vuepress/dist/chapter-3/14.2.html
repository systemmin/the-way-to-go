<!doctype html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.19" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>14.2 协程间的信道 | Go 入门指南 </title><meta name="description" content="The Way to Go">
    <link rel="preload" href="/assets/style-PoWje89h.css" as="style"><link rel="stylesheet" href="/assets/style-PoWje89h.css">
    <link rel="modulepreload" href="/assets/app-DtITwm2S.js"><link rel="modulepreload" href="/assets/14.2.html-BhMOdHKe.js">
    <link rel="prefetch" href="/assets/preface.html-6DZH9Ubj.js" as="script"><link rel="prefetch" href="/assets/index.html-Ck8S5GDx.js" as="script"><link rel="prefetch" href="/assets/介绍.html-Cpc4HhS7.js" as="script"><link rel="prefetch" href="/assets/参数详情.html-7jPPiiO-.js" as="script"><link rel="prefetch" href="/assets/图像.html-CuiCV0kQ.js" as="script"><link rel="prefetch" href="/assets/审核.html-CNJ5oBgL.js" as="script"><link rel="prefetch" href="/assets/嵌入.html-Dm-ZcblN.js" as="script"><link rel="prefetch" href="/assets/引擎.html-C2kiFg-p.js" as="script"><link rel="prefetch" href="/assets/微调.html-DTcL4LME.js" as="script"><link rel="prefetch" href="/assets/文件.html-B29chMrc.js" as="script"><link rel="prefetch" href="/assets/模型.html-CrDaD65q.js" as="script"><link rel="prefetch" href="/assets/编辑.html-BIzO3lYW.js" as="script"><link rel="prefetch" href="/assets/补全.html-DTG8jPu_.js" as="script"><link rel="prefetch" href="/assets/01.1.html-Z7EtjgVs.js" as="script"><link rel="prefetch" href="/assets/01.2.html-BwUS2dml.js" as="script"><link rel="prefetch" href="/assets/02.1.html-DnOKmj_n.js" as="script"><link rel="prefetch" href="/assets/02.2.html-CnA2ZrR6.js" as="script"><link rel="prefetch" href="/assets/02.3.html-CoFfj52b.js" as="script"><link rel="prefetch" href="/assets/02.4.html-DAz_ml-6.js" as="script"><link rel="prefetch" href="/assets/02.5.html-DmYKmXg1.js" as="script"><link rel="prefetch" href="/assets/02.6.html-DGi6Udpr.js" as="script"><link rel="prefetch" href="/assets/02.7.html-DvXtNgwQ.js" as="script"><link rel="prefetch" href="/assets/02.8.html-LfWDv4MS.js" as="script"><link rel="prefetch" href="/assets/03.0.html-Brqlbw8D.js" as="script"><link rel="prefetch" href="/assets/03.1.html-C5oriWik.js" as="script"><link rel="prefetch" href="/assets/03.2.html-C42QINy-.js" as="script"><link rel="prefetch" href="/assets/03.3.html-OpHmP4_E.js" as="script"><link rel="prefetch" href="/assets/03.4.html-aFAI61qP.js" as="script"><link rel="prefetch" href="/assets/03.5.html-Bo_f3Dfr.js" as="script"><link rel="prefetch" href="/assets/03.6.html-B7IBUoJs.js" as="script"><link rel="prefetch" href="/assets/03.7.html-BZiieTGR.js" as="script"><link rel="prefetch" href="/assets/03.8.html-D47bQyKy.js" as="script"><link rel="prefetch" href="/assets/03.9.html-Cf7XBq53.js" as="script"><link rel="prefetch" href="/assets/04.1.html-CNJSY0aV.js" as="script"><link rel="prefetch" href="/assets/04.2.html-cbGABghB.js" as="script"><link rel="prefetch" href="/assets/04.3.html-DXSHS8OT.js" as="script"><link rel="prefetch" href="/assets/04.4.html-4CBNpzSp.js" as="script"><link rel="prefetch" href="/assets/04.5.html-PPJYnsQq.js" as="script"><link rel="prefetch" href="/assets/04.6.html-DGmv1gR6.js" as="script"><link rel="prefetch" href="/assets/04.7.html-DhSmhFJM.js" as="script"><link rel="prefetch" href="/assets/04.8.html-CjawH_DY.js" as="script"><link rel="prefetch" href="/assets/04.9.html-qM_qrQS7.js" as="script"><link rel="prefetch" href="/assets/05.0.html-BhrgSVnv.js" as="script"><link rel="prefetch" href="/assets/05.1.html-DlqruRIh.js" as="script"><link rel="prefetch" href="/assets/05.2.html-CGcsXjWq.js" as="script"><link rel="prefetch" href="/assets/05.3.html-C4aXLyaR.js" as="script"><link rel="prefetch" href="/assets/05.4.html-Begn-oRO.js" as="script"><link rel="prefetch" href="/assets/05.5.html-DgACCQDR.js" as="script"><link rel="prefetch" href="/assets/05.6.html-zrm9lfOP.js" as="script"><link rel="prefetch" href="/assets/06.0.html-Cq0Q4zjI.js" as="script"><link rel="prefetch" href="/assets/06.1.html-CwG3jZMg.js" as="script"><link rel="prefetch" href="/assets/06.10.html-NAZ4iIbE.js" as="script"><link rel="prefetch" href="/assets/06.11.html-DyPB_V4f.js" as="script"><link rel="prefetch" href="/assets/06.12.html-Che8zprd.js" as="script"><link rel="prefetch" href="/assets/06.2.html-DjwDsn8t.js" as="script"><link rel="prefetch" href="/assets/06.3.html-Tt2q3aID.js" as="script"><link rel="prefetch" href="/assets/06.4.html-Cn_c8Aw_.js" as="script"><link rel="prefetch" href="/assets/06.5.html-B2O1T7XP.js" as="script"><link rel="prefetch" href="/assets/06.6.html-Xbsxp1rt.js" as="script"><link rel="prefetch" href="/assets/06.7.html-BRlGcWj-.js" as="script"><link rel="prefetch" href="/assets/06.8.html-CH2taiAQ.js" as="script"><link rel="prefetch" href="/assets/06.9.html-CU4R_era.js" as="script"><link rel="prefetch" href="/assets/07.0.html-C-_7USg4.js" as="script"><link rel="prefetch" href="/assets/07.1.html-D0BpTwwY.js" as="script"><link rel="prefetch" href="/assets/07.2.html-C8lUrkIP.js" as="script"><link rel="prefetch" href="/assets/07.3.html-B1_IRZfJ.js" as="script"><link rel="prefetch" href="/assets/07.4.html-AsDoIa-O.js" as="script"><link rel="prefetch" href="/assets/07.5.html-j4dDJSHq.js" as="script"><link rel="prefetch" href="/assets/07.6.html-B5Jb-JAa.js" as="script"><link rel="prefetch" href="/assets/08.0.html-Z4KWQe4B.js" as="script"><link rel="prefetch" href="/assets/08.1.html-DuSqll6N.js" as="script"><link rel="prefetch" href="/assets/08.2.html-BOoIx8_8.js" as="script"><link rel="prefetch" href="/assets/08.3.html-DGNSIGhe.js" as="script"><link rel="prefetch" href="/assets/08.4.html-sZLPjRoc.js" as="script"><link rel="prefetch" href="/assets/08.5.html-Cg1fn4KQ.js" as="script"><link rel="prefetch" href="/assets/08.6.html-C5s5pV7e.js" as="script"><link rel="prefetch" href="/assets/09.0.html-CDAHZh08.js" as="script"><link rel="prefetch" href="/assets/09.1.html-B86Zb4ds.js" as="script"><link rel="prefetch" href="/assets/09.10.html-DqwOV0e7.js" as="script"><link rel="prefetch" href="/assets/09.11.html-C6tNGK9S.js" as="script"><link rel="prefetch" href="/assets/09.2.html-xe8QrE6h.js" as="script"><link rel="prefetch" href="/assets/09.3.html-CstTfhC4.js" as="script"><link rel="prefetch" href="/assets/09.4.html-BraVc6VC.js" as="script"><link rel="prefetch" href="/assets/09.5.html-CFQyzd6x.js" as="script"><link rel="prefetch" href="/assets/09.6.html-BJdkFgKO.js" as="script"><link rel="prefetch" href="/assets/09.7.html-Ch6xJUNQ.js" as="script"><link rel="prefetch" href="/assets/09.8.html-CTy-_9Sp.js" as="script"><link rel="prefetch" href="/assets/09.9.html-BsOj6Y3D.js" as="script"><link rel="prefetch" href="/assets/10.0.html-BJ3HaT6e.js" as="script"><link rel="prefetch" href="/assets/10.1.html-D8BS7BvM.js" as="script"><link rel="prefetch" href="/assets/10.2.html-BWsGTQyI.js" as="script"><link rel="prefetch" href="/assets/10.3.html-BhdBntye.js" as="script"><link rel="prefetch" href="/assets/10.4.html-B4v_wLqb.js" as="script"><link rel="prefetch" href="/assets/10.5.html-D_TpCHYU.js" as="script"><link rel="prefetch" href="/assets/10.6.html-5q-HRLQu.js" as="script"><link rel="prefetch" href="/assets/10.7.html-CsL-USic.js" as="script"><link rel="prefetch" href="/assets/10.8.html-cU_UYmP8.js" as="script"><link rel="prefetch" href="/assets/11.0.html-DzOFNLkI.js" as="script"><link rel="prefetch" href="/assets/11.1.html-CVDneARq.js" as="script"><link rel="prefetch" href="/assets/11.10.html-DLdzgM0_.js" as="script"><link rel="prefetch" href="/assets/11.11.html-ZUEf79aZ.js" as="script"><link rel="prefetch" href="/assets/11.12.html-moio86bV.js" as="script"><link rel="prefetch" href="/assets/11.13.html-CvewV3ew.js" as="script"><link rel="prefetch" href="/assets/11.14.html-CwU5qxN5.js" as="script"><link rel="prefetch" href="/assets/11.2.html-B8Xk39Ru.js" as="script"><link rel="prefetch" href="/assets/11.3.html-DP6_wJQP.js" as="script"><link rel="prefetch" href="/assets/11.4.html-49fB7Xvo.js" as="script"><link rel="prefetch" href="/assets/11.5.html-DTac0CFp.js" as="script"><link rel="prefetch" href="/assets/11.6.html-Jj-71bcb.js" as="script"><link rel="prefetch" href="/assets/11.7.html-DJYEY4EJ.js" as="script"><link rel="prefetch" href="/assets/11.8.html-DPQr1oVG.js" as="script"><link rel="prefetch" href="/assets/11.9.html-Bt0bssir.js" as="script"><link rel="prefetch" href="/assets/12.0.html-dQogtLlq.js" as="script"><link rel="prefetch" href="/assets/12.1.html-DXE_mHUo.js" as="script"><link rel="prefetch" href="/assets/12.10.html-BK1ALSfx.js" as="script"><link rel="prefetch" href="/assets/12.11.html-CrpC0jD-.js" as="script"><link rel="prefetch" href="/assets/12.12.html-CooGcF3E.js" as="script"><link rel="prefetch" href="/assets/12.2.html-ZVTyjB2f.js" as="script"><link rel="prefetch" href="/assets/12.3.html-qMk0sbyO.js" as="script"><link rel="prefetch" href="/assets/12.4.html-BF7d9E3U.js" as="script"><link rel="prefetch" href="/assets/12.5.html-DOFf0ilh.js" as="script"><link rel="prefetch" href="/assets/12.6.html-BsP--Ufk.js" as="script"><link rel="prefetch" href="/assets/12.7.html-1MPkaJXj.js" as="script"><link rel="prefetch" href="/assets/12.8.html-D8GtXQQP.js" as="script"><link rel="prefetch" href="/assets/12.9.html-CohRgBpn.js" as="script"><link rel="prefetch" href="/assets/13.0.html-CreAz5ks.js" as="script"><link rel="prefetch" href="/assets/13.1.html-D4zIWXVh.js" as="script"><link rel="prefetch" href="/assets/13.10.html-kNO9rh1U.js" as="script"><link rel="prefetch" href="/assets/13.2.html-C1yU2SpY.js" as="script"><link rel="prefetch" href="/assets/13.3.html-Cu4mGJyA.js" as="script"><link rel="prefetch" href="/assets/13.4.html-aR-Ee4EY.js" as="script"><link rel="prefetch" href="/assets/13.5.html-CEXE33nx.js" as="script"><link rel="prefetch" href="/assets/13.6.html-qMxTM7Tz.js" as="script"><link rel="prefetch" href="/assets/13.7.html-DsdN0OYU.js" as="script"><link rel="prefetch" href="/assets/13.8.html-BOmUwdax.js" as="script"><link rel="prefetch" href="/assets/13.9.html-7ZkPdMJ9.js" as="script"><link rel="prefetch" href="/assets/14.0.html-DurcTcL0.js" as="script"><link rel="prefetch" href="/assets/14.1.html-Ccp03uCw.js" as="script"><link rel="prefetch" href="/assets/14.10.html-DNbGnvEw.js" as="script"><link rel="prefetch" href="/assets/14.11.html-DbHSQcwt.js" as="script"><link rel="prefetch" href="/assets/14.12.html-B7qfHHg1.js" as="script"><link rel="prefetch" href="/assets/14.13.html-xlP1FcQ7.js" as="script"><link rel="prefetch" href="/assets/14.14.html-DEZkci8M.js" as="script"><link rel="prefetch" href="/assets/14.15.html-CcpRz-rx.js" as="script"><link rel="prefetch" href="/assets/14.16.html-B-ml7ep0.js" as="script"><link rel="prefetch" href="/assets/14.17.html-BwGR0yvk.js" as="script"><link rel="prefetch" href="/assets/14.3.html-Cv7YtU1e.js" as="script"><link rel="prefetch" href="/assets/14.4.html-BlRZuBKg.js" as="script"><link rel="prefetch" href="/assets/14.5.html-De90eIKp.js" as="script"><link rel="prefetch" href="/assets/14.6.html-Dd7pNYkF.js" as="script"><link rel="prefetch" href="/assets/14.7.html-BbeVVSs6.js" as="script"><link rel="prefetch" href="/assets/14.8.html-D1E1Xwbs.js" as="script"><link rel="prefetch" href="/assets/14.9.html-DzyJl1-8.js" as="script"><link rel="prefetch" href="/assets/15.0.html-B3-P-DUo.js" as="script"><link rel="prefetch" href="/assets/15.1.html-BMAzaA0V.js" as="script"><link rel="prefetch" href="/assets/15.10.html-DpzmUNMu.js" as="script"><link rel="prefetch" href="/assets/15.11.html-Bs9z6Z8J.js" as="script"><link rel="prefetch" href="/assets/15.12.html-JAFWQ0iJ.js" as="script"><link rel="prefetch" href="/assets/15.2.html-ijnhu5Y0.js" as="script"><link rel="prefetch" href="/assets/15.3.html-XHvjsG9O.js" as="script"><link rel="prefetch" href="/assets/15.4.html-Bz5HcOrf.js" as="script"><link rel="prefetch" href="/assets/15.5.html-CmBNVHwb.js" as="script"><link rel="prefetch" href="/assets/15.6.html-C3W-qtEi.js" as="script"><link rel="prefetch" href="/assets/15.7.html-Ddy0cxF4.js" as="script"><link rel="prefetch" href="/assets/15.8.html-DFC4gFUj.js" as="script"><link rel="prefetch" href="/assets/15.9.html-BiAzkYze.js" as="script"><link rel="prefetch" href="/assets/16.0.html-CIktAcLr.js" as="script"><link rel="prefetch" href="/assets/16.1.html-BpZdp4DD.js" as="script"><link rel="prefetch" href="/assets/16.10.html-BRKt5szr.js" as="script"><link rel="prefetch" href="/assets/16.2.html-CXui5XC-.js" as="script"><link rel="prefetch" href="/assets/16.3.html-Db08GLZQ.js" as="script"><link rel="prefetch" href="/assets/16.4.html-ex0KQROM.js" as="script"><link rel="prefetch" href="/assets/16.5.html-VsStOsvR.js" as="script"><link rel="prefetch" href="/assets/16.6.html-CWmZSI_2.js" as="script"><link rel="prefetch" href="/assets/16.7.html-CM4b5Jye.js" as="script"><link rel="prefetch" href="/assets/16.8.html-BalzATae.js" as="script"><link rel="prefetch" href="/assets/16.9.html-BfrhOnAb.js" as="script"><link rel="prefetch" href="/assets/17.0.html-CXHUrq6G.js" as="script"><link rel="prefetch" href="/assets/17.1.html-AGPT-RqU.js" as="script"><link rel="prefetch" href="/assets/17.2.html-Bb16WCnH.js" as="script"><link rel="prefetch" href="/assets/17.3.html-BpyAewq3.js" as="script"><link rel="prefetch" href="/assets/17.4.html-cBjMNRvf.js" as="script"><link rel="prefetch" href="/assets/18.0.html-rKm7zc3d.js" as="script"><link rel="prefetch" href="/assets/18.1.html-gQMwXB-y.js" as="script"><link rel="prefetch" href="/assets/18.10.html-DYEiSx14.js" as="script"><link rel="prefetch" href="/assets/18.11.html-CBA8UOoD.js" as="script"><link rel="prefetch" href="/assets/18.2.html-CTZApRcd.js" as="script"><link rel="prefetch" href="/assets/18.3.html-Dcb-fo-l.js" as="script"><link rel="prefetch" href="/assets/18.4.html-VbPUvJ1W.js" as="script"><link rel="prefetch" href="/assets/18.5.html-wWA9_3iL.js" as="script"><link rel="prefetch" href="/assets/18.6.html-C71a0u1a.js" as="script"><link rel="prefetch" href="/assets/18.7.html-9WzyG31d.js" as="script"><link rel="prefetch" href="/assets/18.8.html-xOxRJQmB.js" as="script"><link rel="prefetch" href="/assets/18.9.html-DS96uovJ.js" as="script"><link rel="prefetch" href="/assets/19.0.html-DfbBkvWu.js" as="script"><link rel="prefetch" href="/assets/19.1.html-1XfJVBPI.js" as="script"><link rel="prefetch" href="/assets/19.10.html--4BRYOye.js" as="script"><link rel="prefetch" href="/assets/19.2.html-PzkPaejK.js" as="script"><link rel="prefetch" href="/assets/19.3.html-Dhqr7Iwc.js" as="script"><link rel="prefetch" href="/assets/19.4.html-1Toz6F77.js" as="script"><link rel="prefetch" href="/assets/19.5.html-BhWIqAga.js" as="script"><link rel="prefetch" href="/assets/19.6.html-Ba6ga2O7.js" as="script"><link rel="prefetch" href="/assets/19.7.html-BfH6T1_e.js" as="script"><link rel="prefetch" href="/assets/19.8.html-Buh82owD.js" as="script"><link rel="prefetch" href="/assets/19.9.html-Ck68g8vc.js" as="script"><link rel="prefetch" href="/assets/20.0.html-B8c35N13.js" as="script"><link rel="prefetch" href="/assets/20.1.html-BT42TUQN.js" as="script"><link rel="prefetch" href="/assets/20.2.html-pJjft2Jz.js" as="script"><link rel="prefetch" href="/assets/20.3.html-DJ3pzRtd.js" as="script"><link rel="prefetch" href="/assets/20.4.html-CQWeeuFr.js" as="script"><link rel="prefetch" href="/assets/20.5.html-Bs422AVL.js" as="script"><link rel="prefetch" href="/assets/20.6.html-CflDr4LM.js" as="script"><link rel="prefetch" href="/assets/20.7.html-CH2ZzonR.js" as="script"><link rel="prefetch" href="/assets/20.8.html-Bdietje8.js" as="script"><link rel="prefetch" href="/assets/21.0.html-zvMiB2jK.js" as="script"><link rel="prefetch" href="/assets/21.1.html-DGmS19j8.js" as="script"><link rel="prefetch" href="/assets/21.2.html-CpWQo4j1.js" as="script"><link rel="prefetch" href="/assets/21.3.html-0OFiGCR_.js" as="script"><link rel="prefetch" href="/assets/21.4.html-5BrXRnkE.js" as="script"><link rel="prefetch" href="/assets/21.5.html-DPEV2HhV.js" as="script"><link rel="prefetch" href="/assets/代码补全.html-BUBz9Fwc.js" as="script"><link rel="prefetch" href="/assets/图像生成.html-CfCSRVaC.js" as="script"><link rel="prefetch" href="/assets/安全最佳实践.html-SoPVYDvG.js" as="script"><link rel="prefetch" href="/assets/审核.html-DKB7LJQp.js" as="script"><link rel="prefetch" href="/assets/嵌入.html-D-0DUkFJ.js" as="script"><link rel="prefetch" href="/assets/微调.html-B3jYGIVH.js" as="script"><link rel="prefetch" href="/assets/文本补全.html-CaPPW8UW.js" as="script"><link rel="prefetch" href="/assets/生产最佳实践.html-C2brpABt.js" as="script"><link rel="prefetch" href="/assets/速率限制.html-WEy4cpmi.js" as="script"><link rel="prefetch" href="/assets/错误状态码.html-beVo4FUJ.js" as="script"><link rel="prefetch" href="/assets/介绍.html-DWSLTx96.js" as="script"><link rel="prefetch" href="/assets/使用政策.html-B58OOuRc.js" as="script"><link rel="prefetch" href="/assets/如何构建可以回答有关您网站的问题的-AI.html-BASypKYV.js" as="script"><link rel="prefetch" href="/assets/库.html-CKEmRIu8.js" as="script"><link rel="prefetch" href="/assets/快速开始.html-Bi0cQAVx.js" as="script"><link rel="prefetch" href="/assets/教程.html-CdbZYQLZ.js" as="script"><link rel="prefetch" href="/assets/模型.html-D9OC_ema.js" as="script"><link rel="prefetch" href="/assets/404.html-6BVqY2BK.js" as="script"><link rel="prefetch" href="/assets/setupDevtools-7MC2TMWH-BreutQJ-.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="vp-site-logo" src="/images/logo.svg" alt="Go 入门指南 "><span class="vp-site-name vp-hide-mobile" aria-hidden="true">Go 入门指南 </span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="auto-link external-link" href="https://openai.com/" aria-label="官网" rel="noopener noreferrer" target="_blank"><!---->官网<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/unknwon/the-way-to-go_ZH_CN" aria-label="译者 GitHub" rel="noopener noreferrer" target="_blank"><!---->译者 GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="auto-link external-link" href="https://openai.com/" aria-label="官网" rel="noopener noreferrer" target="_blank"><!---->官网<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/unknwon/the-way-to-go_ZH_CN" aria-label="译者 GitHub" rel="noopener noreferrer" target="_blank"><!---->译者 GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/preface.html" aria-label="前言"><!---->前言<!----></a><!----></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">学习 Go 语言 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><p tabindex="0" class="vp-sidebar-item">第1章：Go 语言的起源，发展与普及 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/01.1.html" aria-label="1.1 起源与发展"><!---->1.1 起源与发展<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/01.2.html" aria-label="1.2 语言的主要特性与发展的环境和影响因素"><!---->1.2 语言的主要特性与发展的环境和影响因素<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第2章：安装与运行环境 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/02.1.html" aria-label="2.1 平台与架构"><!---->2.1 平台与架构<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/02.2.html" aria-label="2.2 Go 环境变量"><!---->2.2 Go 环境变量<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/02.3.html" aria-label="2.3 在 Linux 上安装 Go"><!---->2.3 在 Linux 上安装 Go<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/02.4.html" aria-label="2.4 在 Mac OS X 上安装 Go"><!---->2.4 在 Mac OS X 上安装 Go<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/02.5.html" aria-label="2.5 在 Windows 上安装 Go"><!---->2.5 在 Windows 上安装 Go<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/02.6.html" aria-label="2.6 安装目录清单"><!---->2.6 安装目录清单<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/02.7.html" aria-label="2.7 Go 运行时 (runtime)"><!---->2.7 Go 运行时 (runtime)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/02.8.html" aria-label="2.8 Go 解释器"><!---->2.8 Go 解释器<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第3章：编辑器、集成开发环境与其它工具 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/03.1.html" aria-label="3.1 Go 开发环境的基本要求"><!---->3.1 Go 开发环境的基本要求<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/03.2.html" aria-label="3.2 编辑器和集成开发环境"><!---->3.2 编辑器和集成开发环境<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/03.3.html" aria-label="3.3 调试器"><!---->3.3 调试器<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/03.4.html" aria-label="3.4 构建并运行 Go 程序"><!---->3.4 构建并运行 Go 程序<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/03.5.html" aria-label="3.5 格式化代码"><!---->3.5 格式化代码<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/03.6.html" aria-label="3.6 生成代码文档"><!---->3.6 生成代码文档<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/03.7.html" aria-label="3.7 其它工具"><!---->3.7 其它工具<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/03.8.html" aria-label="3.8 Go 性能说明"><!---->3.8 Go 性能说明<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-1/03.9.html" aria-label="3.9 与其它语言进行交互"><!---->3.9 与其它语言进行交互<!----></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">语言的核心结构与技术 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><p tabindex="0" class="vp-sidebar-item">第4章：基本结构和基本数据类型 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/04.1.html" aria-label="4.1 文件名、关键字与标识符"><!---->4.1 文件名、关键字与标识符<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/04.2.html" aria-label="4.2 Go 程序的基本结构和要素"><!---->4.2 Go 程序的基本结构和要素<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/04.3.html" aria-label="4.3 常量"><!---->4.3 常量<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/04.4.html" aria-label="4.4 变量"><!---->4.4 变量<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/04.5.html" aria-label="4.5 基本类型和运算符"><!---->4.5 基本类型和运算符<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/04.6.html" aria-label="4.6 字符串"><!---->4.6 字符串<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/04.7.html" aria-label="4.7 strings 和 strconv 包"><!---->4.7 strings 和 strconv 包<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/04.8.html" aria-label="4.8 时间和日期"><!---->4.8 时间和日期<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/04.9.html" aria-label="4.9 指针"><!---->4.9 指针<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第5章：控制结构 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/05.1.html" aria-label="5.1 if-else 结构"><!---->5.1 if-else 结构<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/05.2.html" aria-label="5.2 测试多返回值函数的错误"><!---->5.2 测试多返回值函数的错误<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/05.3.html" aria-label="5.3 switch 结构"><!---->5.3 switch 结构<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/05.4.html" aria-label="5.4 for 结构"><!---->5.4 for 结构<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/05.5.html" aria-label="5.5 break 与 continue"><!---->5.5 break 与 continue<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/05.6.html" aria-label="5.6 标签与 goto"><!---->5.6 标签与 goto<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第6章：函数（function） <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.1.html" aria-label="6.1 介绍"><!---->6.1 介绍<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.2.html" aria-label="6.2 函数参数与返回值"><!---->6.2 函数参数与返回值<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.3.html" aria-label="6.3 传递变长参数"><!---->6.3 传递变长参数<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.4.html" aria-label="6.4 defer 和追踪"><!---->6.4 defer 和追踪<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.5.html" aria-label="6.5 内置函数"><!---->6.5 内置函数<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.6.html" aria-label="6.6 递归函数"><!---->6.6 递归函数<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.7.html" aria-label="6.7 将函数作为参数"><!---->6.7 将函数作为参数<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.8.html" aria-label="6.8 闭包"><!---->6.8 闭包<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.9.html" aria-label="6.9 应用闭包：将函数作为返回值"><!---->6.9 应用闭包：将函数作为返回值<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.10.html" aria-label="6.10 使用闭包调试"><!---->6.10 使用闭包调试<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.11.html" aria-label="6.11 计算函数执行时间"><!---->6.11 计算函数执行时间<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.12.html" aria-label="6.12 通过内存缓存来提升性能"><!---->6.12 通过内存缓存来提升性能<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第7章：数组与切片 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.1.html" aria-label="6.1 介绍"><!---->6.1 介绍<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.2.html" aria-label="6.2 函数参数与返回值"><!---->6.2 函数参数与返回值<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.3.html" aria-label="6.3 传递变长参数"><!---->6.3 传递变长参数<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.4.html" aria-label="6.4 defer 和追踪"><!---->6.4 defer 和追踪<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.5.html" aria-label="6.5 内置函数"><!---->6.5 内置函数<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/06.6.html" aria-label="6.6 递归函数"><!---->6.6 递归函数<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第8章：Map <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/08.1.html" aria-label="8.1 声明、初始化和 make"><!---->8.1 声明、初始化和 make<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/08.2.html" aria-label="8.2 测试键值对是否存在及删除元素"><!---->8.2 测试键值对是否存在及删除元素<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/08.3.html" aria-label="8.3 for-range 的配套用法"><!---->8.3 for-range 的配套用法<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/08.4.html" aria-label="8.4 map 类型的切片"><!---->8.4 map 类型的切片<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/08.5.html" aria-label="8.5 map 的排序"><!---->8.5 map 的排序<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/08.6.html" aria-label="8.6 将 map 的键值对调"><!---->8.6 将 map 的键值对调<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第9章：包（package） <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/09.1.html" aria-label="9.1 标准库概述"><!---->9.1 标准库概述<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/09.2.html" aria-label="9.2 regexp 包"><!---->9.2 regexp 包<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/09.3.html" aria-label="9.3 锁和 sync 包"><!---->9.3 锁和 sync 包<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/09.4.html" aria-label="9.4 精密计算和 big 包"><!---->9.4 精密计算和 big 包<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/09.5.html" aria-label="9.5 自定义包和可见性"><!---->9.5 自定义包和可见性<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/09.6.html" aria-label="9.6 为自定义包使用 godoc"><!---->9.6 为自定义包使用 godoc<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/09.7.html" aria-label="9.7 使用 go install 安装自定义包"><!---->9.7 使用 go install 安装自定义包<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/09.8.html" aria-label="9.8 自定义包的目录结构、go install 和 go test"><!---->9.8 自定义包的目录结构、go install 和 go test<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/09.9.html" aria-label="9.9 通过 Git 打包和安装"><!---->9.9 通过 Git 打包和安装<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/09.10.html" aria-label="9.10 Go 的外部包和项目"><!---->9.10 Go 的外部包和项目<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/09.11.html" aria-label="9.11 在 Go 程序中使用外部库"><!---->9.11 在 Go 程序中使用外部库<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第10章：结构（struct）与方法（method） <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/10.1.html" aria-label="10.1 结构体定义"><!---->10.1 结构体定义<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/10.2.html" aria-label="10.2 使用工厂方法创建结构体实例"><!---->10.2 使用工厂方法创建结构体实例<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/10.3.html" aria-label="10.3 使用自定义包中的结构体"><!---->10.3 使用自定义包中的结构体<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/10.4.html" aria-label="10.4 带标签的结构体"><!---->10.4 带标签的结构体<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/10.5.html" aria-label="10.5 匿名字段和内嵌结构体"><!---->10.5 匿名字段和内嵌结构体<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/10.6.html" aria-label="10.6 方法"><!---->10.6 方法<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/10.7.html" aria-label="10.7 类型的 String() 方法和格式化描述符"><!---->10.7 类型的 String() 方法和格式化描述符<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/10.8.html" aria-label="10.8 垃圾回收和 SetFinalizer"><!---->10.8 垃圾回收和 SetFinalizer<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第11章：接口（interface）与反射（reflection） <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.1.html" aria-label="11.1 接口是什么"><!---->11.1 接口是什么<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.2.html" aria-label="11.2 接口嵌套接口"><!---->11.2 接口嵌套接口<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.3.html" aria-label="11.3 类型断言：如何检测和转换接口变量的类型"><!---->11.3 类型断言：如何检测和转换接口变量的类型<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.4.html" aria-label="11.4 类型判断：type-switch"><!---->11.4 类型判断：type-switch<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.5.html" aria-label="11.5 测试一个值是否实现了某个接口"><!---->11.5 测试一个值是否实现了某个接口<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.6.html" aria-label="11.6 使用方法集与接口"><!---->11.6 使用方法集与接口<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.7.html" aria-label="11.7 第一个例子：使用 Sorter 接口排序"><!---->11.7 第一个例子：使用 Sorter 接口排序<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.8.html" aria-label="11.8 第二个例子：读和写"><!---->11.8 第二个例子：读和写<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.9.html" aria-label="11.9 空接口"><!---->11.9 空接口<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.10.html" aria-label="11.10 反射包"><!---->11.10 反射包<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.11.html" aria-label="11.11 Printf() 和反射"><!---->11.11 Printf() 和反射<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.12.html" aria-label="11.12 接口与动态类型"><!---->11.12 接口与动态类型<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.13.html" aria-label="11.13 总结：Go 中的面向对象"><!---->11.13 总结：Go 中的面向对象<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-2/11.14.html" aria-label="11.14 结构体、集合和高阶函数"><!---->11.14 结构体、集合和高阶函数<!----></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active">Go 高级编程 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><p tabindex="0" class="vp-sidebar-item">第12章：读写数据 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.1.html" aria-label="12.1 读取用户的输入"><!---->12.1 读取用户的输入<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.2.html" aria-label="12.2 文件读写"><!---->12.2 文件读写<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.3.html" aria-label="12.3 文件拷贝"><!---->12.3 文件拷贝<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.4.html" aria-label="12.4 从命令行读取参数"><!---->12.4 从命令行读取参数<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.5.html" aria-label="12.5 用 buffer 读取文件"><!---->12.5 用 buffer 读取文件<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.6.html" aria-label="12.6 用切片读写文件"><!---->12.6 用切片读写文件<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.7.html" aria-label="12.7 用 defer 关闭文件"><!---->12.7 用 defer 关闭文件<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.8.html" aria-label="12.8 使用接口的实际例子：fmt.Fprintf"><!---->12.8 使用接口的实际例子：fmt.Fprintf<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.9.html" aria-label="12.9 JSON 数据格式"><!---->12.9 JSON 数据格式<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.10.html" aria-label="12.10 XML 数据格式"><!---->12.10 XML 数据格式<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.11.html" aria-label="12.11 用 Gob 传输数据"><!---->12.11 用 Gob 传输数据<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/12.12.html" aria-label="12.12 Go 中的密码学"><!---->12.12 Go 中的密码学<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第13章：错误处理与测试 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/13.1.html" aria-label="13.1 错误处理"><!---->13.1 错误处理<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/13.2.html" aria-label="13.2 运行时异常和 panic"><!---->13.2 运行时异常和 panic<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/13.3.html" aria-label="13.3 从 panic 中恢复 (recover)"><!---->13.3 从 panic 中恢复 (recover)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/13.4.html" aria-label="13.4 自定义包中的错误处理和 panicking"><!---->13.4 自定义包中的错误处理和 panicking<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/13.5.html" aria-label="13.5 一种用闭包处理错误的模式"><!---->13.5 一种用闭包处理错误的模式<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/13.6.html" aria-label="13.6 启动外部命令和程序"><!---->13.6 启动外部命令和程序<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/13.7.html" aria-label="13.7 Go 中的单元测试和基准测试"><!---->13.7 Go 中的单元测试和基准测试<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/13.8.html" aria-label="13.8 测试的具体例子"><!---->13.8 测试的具体例子<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/13.9.html" aria-label="13.9 用（测试数据）表驱动测试"><!---->13.9 用（测试数据）表驱动测试<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/13.10.html" aria-label="13.10 性能调试：分析并优化 Go 程序"><!---->13.10 性能调试：分析并优化 Go 程序<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item active">第14章：协程 (goroutine) 与通道 (channel) <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.1.html" aria-label="14.1 并发、并行和协程"><!---->14.1 并发、并行和协程<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/chapter-3/14.2.html" aria-label="14.2 协程间的信道"><!---->14.2 协程间的信道<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.3.html" aria-label="14.3 协程的同步：关闭通道-测试阻塞的通道"><!---->14.3 协程的同步：关闭通道-测试阻塞的通道<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.4.html" aria-label="14.4 使用 select 切换协程"><!---->14.4 使用 select 切换协程<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.5.html" aria-label="14.5 通道、超时和计时器（Ticker）"><!---->14.5 通道、超时和计时器（Ticker）<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.6.html" aria-label="14.6 协程和恢复 (recover)"><!---->14.6 协程和恢复 (recover)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.7.html" aria-label="14.7 新旧模型对比：任务和 worker"><!---->14.7 新旧模型对比：任务和 worker<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.8.html" aria-label="14.8 惰性生成器的实现"><!---->14.8 惰性生成器的实现<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.9.html" aria-label="14.9 实现 Futures 模式"><!---->14.9 实现 Futures 模式<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.10.html" aria-label="14.10 复用"><!---->14.10 复用<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.11.html" aria-label="14.11 限制同时处理的请求数"><!---->14.11 限制同时处理的请求数<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.12.html" aria-label="14.12 链式协程"><!---->14.12 链式协程<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.13.html" aria-label="14.13 在多核心上并行计算"><!---->14.13 在多核心上并行计算<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.14.html" aria-label="14.14 并行化大量数据的计算"><!---->14.14 并行化大量数据的计算<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.15.html" aria-label="14.15 漏桶算法"><!---->14.15 漏桶算法<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.16.html" aria-label="14.16 对 Go 协程进行基准测试"><!---->14.16 对 Go 协程进行基准测试<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/14.17.html" aria-label="14.17 使用通道并发访问对象"><!---->14.17 使用通道并发访问对象<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第 15 章：网络、模板与网页应用 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.1.html" aria-label="15.1 tcp 服务器"><!---->15.1 tcp 服务器<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.2.html" aria-label="15.2 一个简单的 web 服务器"><!---->15.2 一个简单的 web 服务器<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.3.html" aria-label="15.3 访问并读取页面数据"><!---->15.3 访问并读取页面数据<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.4.html" aria-label="15.4 写一个简单的网页应用"><!---->15.4 写一个简单的网页应用<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.5.html" aria-label="15.5 确保网页应用健壮"><!---->15.5 确保网页应用健壮<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.6.html" aria-label="15.6 用模板编写网页应用"><!---->15.6 用模板编写网页应用<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.7.html" aria-label="15.7 探索 template 包"><!---->15.7 探索 template 包<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.8.html" aria-label="15.8 精巧的多功能网页服务器"><!---->15.8 精巧的多功能网页服务器<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.9.html" aria-label="15.9 用 rpc 实现远程过程调用"><!---->15.9 用 rpc 实现远程过程调用<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.10.html" aria-label="15.10 基于网络的通道 netchan"><!---->15.10 基于网络的通道 netchan<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.11.html" aria-label="15.11 与 websocket 通信"><!---->15.11 与 websocket 通信<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-3/15.12.html" aria-label="15.12 用 smtp 发送邮件"><!---->15.12 用 smtp 发送邮件<!----></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">实际应用 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><p tabindex="0" class="vp-sidebar-item">第16章：常见的陷阱与错误 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/16.1.html" aria-label="16.1 误用短声明导致变量覆盖"><!---->16.1 误用短声明导致变量覆盖<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/16.2.html" aria-label="16.2 误用字符串"><!---->16.2 误用字符串<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/16.3.html" aria-label="16.3 发生错误时使用 defer 关闭一个文件"><!---->16.3 发生错误时使用 defer 关闭一个文件<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/16.4.html" aria-label="16.4 何时使用 new() 和 make()"><!---->16.4 何时使用 new() 和 make()<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/16.5.html" aria-label="16.5 不需要将一个指向切片的指针传递给函数"><!---->16.5 不需要将一个指向切片的指针传递给函数<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/16.6.html" aria-label="16.6 使用指针指向接口类型"><!---->16.6 使用指针指向接口类型<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/16.7.html" aria-label="16.7 使用值类型时误用指针"><!---->16.7 使用值类型时误用指针<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/16.8.html" aria-label="16.8 误用协程和通道"><!---->16.8 误用协程和通道<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/16.9.html" aria-label="16.9 闭包和协程的使用"><!---->16.9 闭包和协程的使用<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/16.10.html" aria-label="16.10 糟糕的错误处理"><!---->16.10 糟糕的错误处理<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第17章：模式 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/17.1.html" aria-label="17.1 逗号 ok 模式"><!---->17.1 逗号 ok 模式<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/17.2.html" aria-label="17.2 defer 模式"><!---->17.2 defer 模式<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/17.3.html" aria-label="17.3 可见性模式"><!---->17.3 可见性模式<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/17.4.html" aria-label="17.4 运算符模式和接口"><!---->17.4 运算符模式和接口<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第18章：出于性能考虑的实用代码片段 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/18.1.html" aria-label="18.1 字符串"><!---->18.1 字符串<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/18.2.html" aria-label="18.2 数组和切片"><!---->18.2 数组和切片<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/18.3.html" aria-label="18.3 映射"><!---->18.3 映射<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/18.4.html" aria-label="18.4 结构体"><!---->18.4 结构体<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/18.5.html" aria-label="18.5 接口"><!---->18.5 接口<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/18.6.html" aria-label="18.6 函数"><!---->18.6 函数<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/18.7.html" aria-label="18.7 文件"><!---->18.7 文件<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/18.8.html" aria-label="18.8 协程 (goroutine) 与通道 (channel)"><!---->18.8 协程 (goroutine) 与通道 (channel)<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/18.9.html" aria-label="18.9 网络和网页应用"><!---->18.9 网络和网页应用<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/18.10.html" aria-label="18.10 其他"><!---->18.10 其他<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/18.11.html" aria-label="18.11 出于性能考虑的最佳实践和建议"><!---->18.11 出于性能考虑的最佳实践和建议<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第19章：构建一个完整的应用程序 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/19.1.html" aria-label="19.1 简介"><!---->19.1 简介<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/19.2.html" aria-label="19.2 短网址项目简介"><!---->19.2 短网址项目简介<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/19.3.html" aria-label="版本 1 - 数据结构和前端界面"><!---->版本 1 - 数据结构和前端界面<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/19.4.html" aria-label="19.4 用户界面：web 服务端"><!---->19.4 用户界面：web 服务端<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/19.5.html" aria-label="版本 2 - 添加持久化存储"><!---->版本 2 - 添加持久化存储<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/19.6.html" aria-label="版本 3 - 添加协程"><!---->版本 3 - 添加协程<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/19.7.html" aria-label="版本 4 - 用 JSON 持久化存储"><!---->版本 4 - 用 JSON 持久化存储<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/19.8.html" aria-label="版本 5 - 分布式程序"><!---->版本 5 - 分布式程序<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/19.9.html" aria-label="19.9 使用代理缓存"><!---->19.9 使用代理缓存<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/19.10.html" aria-label="19.10 总结和增强"><!---->19.10 总结和增强<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第20章：Go 语言在 Google App Engine 的使用 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/20.1.html" aria-label="20.1 什么是 Google App Engine？"><!---->20.1 什么是 Google App Engine？<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/20.2.html" aria-label="20.2 云上的 Go"><!---->20.2 云上的 Go<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/20.3.html" aria-label="20.3 安装 Go App Engine SDK：为 Go 部署的开发环境"><!---->20.3 安装 Go App Engine SDK：为 Go 部署的开发环境<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/20.4.html" aria-label="20.4 建造你自己的 Hello world 应用"><!---->20.4 建造你自己的 Hello world 应用<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/20.5.html" aria-label="20.5 使用用户服务和探索其 API"><!---->20.5 使用用户服务和探索其 API<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/20.6.html" aria-label="20.6 处理窗口"><!---->20.6 处理窗口<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/20.7.html" aria-label="20.7 使用数据存储"><!---->20.7 使用数据存储<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/20.8.html" aria-label="20.8 上传到云端"><!---->20.8 上传到云端<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">第21章：实世界中 Go 的使用 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/21.1.html" aria-label="21.1 Heroku：一个使用 Go 的高度可用一致数据存储"><!---->21.1 Heroku：一个使用 Go 的高度可用一致数据存储<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/21.2.html" aria-label="21.2 MROffice：一个使用 Go 的呼叫中心网络电话 (VOIP) 系统"><!---->21.2 MROffice：一个使用 Go 的呼叫中心网络电话 (VOIP) 系统<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/21.3.html" aria-label="21.3 Atlassian：一个虚拟机群管理系统"><!---->21.3 Atlassian：一个虚拟机群管理系统<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/21.4.html" aria-label="21.4 Camilistore：一个可寻址内容存储系统"><!---->21.4 Camilistore：一个可寻址内容存储系统<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/chapter-4/21.5.html" aria-label="21.5 Go 语言的其他应用"><!---->21.5 Go 语言的其他应用<!----></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="_14-2-协程间的信道" tabindex="-1"><a class="header-anchor" href="#_14-2-协程间的信道"><span>14.2 协程间的信道</span></a></h1><h2 id="_14-2-1-概念" tabindex="-1"><a class="header-anchor" href="#_14-2-1-概念"><span>14.2.1 概念</span></a></h2><p>在第一个例子中，协程是独立执行的，他们之间没有通信。他们必须通信才会变得更有用：彼此之间发送和接收信息并且协调/同步他们的工作。协程可以使用共享变量来通信，但是很不提倡这样做，因为这种方式给所有的共享内存的多线程都带来了困难。</p><p>而 Go 有一种特殊的类型，<em>通道（channel）</em>，就像一个可以用于发送类型化数据的管道，由其负责协程之间的通信，从而避开所有由共享内存导致的陷阱；这种通过通道进行通信的方式保证了同步性。数据在通道中进行传递：<em>在任何给定时间，一个数据被设计为只有一个协程可以对其访问，所以不会发生数据竞争。</em> 数据的所有权（可以读写数据的能力）也因此被传递。</p><p>工厂的传送带是个很有用的例子。一个机器（生产者协程）在传送带上放置物品，另外一个机器（消费者协程）拿到物品并打包。</p><p>通道服务于通信的两个目的：值的交换，同步的，保证了两个计算（协程）任何时候都是可知状态。</p><p><img src="/images/14.2_fig14.1.png" alt=""></p><p>通常使用这样的格式来声明通道：<code>var identifier chan datatype</code></p><p>未初始化的通道的值是 <code>nil</code>。</p><p>所以通道只能传输一种类型的数据，比如 <code>chan int</code> 或者 <code>chan string</code>，所有的类型都可以用于通道，空接口 <code>interface{}</code> 也可以，甚至可以（有时非常有用）创建通道的通道。</p><p>通道实际上是类型化消息的队列：使数据得以传输。它是先进先出(FIFO) 的结构所以可以保证发送给他们的元素的顺序（有些人知道，通道可以比作 Unix shells 中的双向管道 (two-way pipe) ）。通道也是引用类型，所以我们使用 <code>make()</code> 函数来给它分配内存。这里先声明了一个字符串通道 ch1，然后创建了它（实例化）：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">var</span> ch1 <span class="token keyword">chan</span> <span class="token builtin">string</span></span>
<span class="line">ch1 <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>当然可以更短： <code>ch1 := make(chan string)</code>。</p><p>这里我们构建一个 int 通道的通道： <code>chanOfChans := make(chan chan int)</code>。</p><p>或者函数通道：<code>funcChan := make(chan func())</code>（相关示例请看第 <a class="route-link" href="/chapter-3/14.17.html">14.17</a> 节）。</p><p>所以通道是第一类对象：可以存储在变量中，作为函数的参数传递，从函数返回以及通过通道发送它们自身。另外它们是类型化的，允许类型检查，比如尝试使用整数通道发送一个指针。</p><h2 id="_14-2-2-通信操作符" tabindex="-1"><a class="header-anchor" href="#_14-2-2-通信操作符"><span>14.2.2 通信操作符 &lt;-</span></a></h2><p>这个操作符直观的标示了数据的传输：信息按照箭头的方向流动。</p><p>流向通道（发送）</p><p><code>ch &lt;- int1</code> 表示：用通道 <code>ch</code> 发送变量 <code>int1</code>（双目运算符，中缀 = 发送）</p><p>从通道流出（接收），三种方式：</p><p><code>int2 = &lt;- ch</code> 表示：变量 <code>int2</code> 从通道 ch（一元运算的前缀操作符，前缀 = 接收）接收数据（获取新值）；假设 <code>int2</code> 已经声明过了，如果没有的话可以写成：<code>int2 := &lt;- ch</code>。</p><p><code>&lt;- ch</code> 可以单独调用获取通道的（下一个）值，当前值会被丢弃，但是可以用来验证，所以以下代码是合法的：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">if</span> <span class="token operator">&lt;-</span> ch <span class="token operator">!=</span> <span class="token number">1000</span><span class="token punctuation">{</span></span>
<span class="line">	<span class="token operator">...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同一个操作符 <code>&lt;-</code> 既用于<strong>发送</strong>也用于<strong>接收</strong>，但 Go 会根据操作对象弄明白该干什么 。虽非强制要求，但为了可读性通道的命名通常以 <code>ch</code> 开头或者包含 <code>chan</code> 。通道的发送和接收都是原子操作：它们总是互不干扰地完成。下面的示例展示了通信操作符的使用。</p><p>示例 14.2-<a href="examples/chapter_14/goroutine2.go">goroutine2.go</a></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">&quot;fmt&quot;</span></span>
<span class="line">	<span class="token string">&quot;time&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">go</span> <span class="token function">sendData</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token function">getData</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">sendData</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Washington&quot;</span></span>
<span class="line">	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Tripoli&quot;</span></span>
<span class="line">	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;London&quot;</span></span>
<span class="line">	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Beijing&quot;</span></span>
<span class="line">	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Tokyo&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">getData</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">var</span> input <span class="token builtin">string</span></span>
<span class="line">	<span class="token comment">// time.Sleep(2e9)</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">		input <span class="token operator">=</span> <span class="token operator">&lt;-</span>ch</span>
<span class="line">		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s &quot;</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Washington Tripoli London Beijing tokyo</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><code>main()</code> 函数中启动了两个协程：<code>sendData()</code> 通过通道 ch 发送了 5 个字符串，<code>getData()</code> 按顺序接收它们并打印出来。</p><p>如果 2 个协程需要通信，你必须给他们同一个通道作为参数才行。</p><p>尝试一下如果注释掉 <code>time.Sleep(1e9)</code> 会如何。</p><p>我们发现协程之间的同步非常重要：</p><ul><li><code>main()</code> 等待了 1 秒让两个协程完成，如果不这样，<code>sendData()</code> 就没有机会输出。</li><li><code>getData()</code> 使用了无限循环：它随着 <code>sendData()</code> 的发送完成和 <code>ch</code> 变空也结束了。</li><li>如果我们移除一个或所有 <code>go</code> 关键字，程序无法运行，Go 运行时会抛出 panic：</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">---- Error run E:/Go/Goboek/code examples/chapter 14/goroutine2.exe with code Crashed ---- Program exited with code -2147483645: panic: all goroutines are asleep-deadlock!</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>为什么会这样？运行时 (runtime) 会检查所有的协程（像本例中只有一个）是否在等待着什么东西（可从某个通道读取或者写入某个通道），这意味着程序将无法继续执行。这是死锁 (deadlock) 的一种形式，而运行时 (runtime) 可以为我们检测到这种情况。</p><p>注意：不要使用打印状态来表明通道的发送和接收顺序：由于打印状态和通道实际发生读写的时间延迟会导致和真实发生的顺序不同。</p><p>练习 14.4：解释一下为什么如果在函数 <code>getData()</code> 的一开始插入 <code>time.Sleep(2e9)</code>，不会出现错误但也没有输出呢。</p><h2 id="_14-2-3-通道阻塞" tabindex="-1"><a class="header-anchor" href="#_14-2-3-通道阻塞"><span>14.2.3 通道阻塞</span></a></h2><p>默认情况下，通信是同步且无缓冲的：在有接受者接收数据之前，发送不会结束。可以想象一个无缓冲的通道在没有空间来保存数据的时候：必须要一个接收者准备好接收通道的数据然后发送者可以直接把数据发送给接收者。所以通道的发送/接收操作在对方准备好之前是阻塞的：</p><p>1）对于同一个通道，发送操作（协程或者函数中的），在接收者准备好之前是阻塞的：如果 <code>ch</code> 中的数据无人接收，就无法再给通道传入其他数据：新的输入无法在通道非空的情况下传入。所以发送操作会等待 <code>ch</code> 再次变为可用状态：就是通道值被接收时（可以传入变量）。</p><p>2）对于同一个通道，接收操作是阻塞的（协程或函数中的），直到发送者可用：如果通道中没有数据，接收者就阻塞了。</p><p>尽管这看上去是非常严格的约束，实际在大部分情况下工作的很不错。</p><p>程序 <a href="examples/chapter_14/channel_block.go">channel_block.go</a> 验证了以上理论，一个协程在无限循环中给通道发送整数数据。不过因为没有接收者，只输出了一个数字 <code>0</code>。</p><p>示例 14.3-<a href="examples/chapter_14/channel_block.go">channel_block.go</a></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	ch1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token function">pump</span><span class="token punctuation">(</span>ch1<span class="token punctuation">)</span>       <span class="token comment">// pump hangs</span></span>
<span class="line">	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch1<span class="token punctuation">)</span> <span class="token comment">// prints only 0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">pump</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">		ch <span class="token operator">&lt;-</span> i</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">0</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><code>pump()</code> 函数为通道提供数值，也被叫做生产者。</p><p>为通道解除阻塞定义了 <code>suck()</code> 函数来在无限循环中读取通道，参见示例 14.4-<a href="examples/chapter_14/channel_block2.go">channel_block2.go</a>：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">suck</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>main()</code> 中使用协程开始它：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">go</span> <span class="token function">pump</span><span class="token punctuation">(</span>ch1<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">go</span> <span class="token function">suck</span><span class="token punctuation">(</span>ch1<span class="token punctuation">)</span></span>
<span class="line">time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>给程序 1 秒的时间来运行：输出了上万个整数。</p><p>练习 14.1：<a href="exercises/chapter_14/channel_block3.go">channel_block3.go</a>：写一个通道证明它的阻塞性，开启一个协程接收通道的数据，持续 15 秒，然后给通道放入一个值。在不同的阶段打印消息并观察输出。</p><h2 id="_14-2-4-通过一个-或多个-通道交换数据进行协程同步。" tabindex="-1"><a class="header-anchor" href="#_14-2-4-通过一个-或多个-通道交换数据进行协程同步。"><span>14.2.4 通过一个（或多个）通道交换数据进行协程同步。</span></a></h2><p>通信是一种同步形式：通过通道，两个协程在通信（协程会合）中某刻同步交换数据。无缓冲通道成为了多个协程同步的完美工具。</p><p>甚至可以在通道两端互相阻塞对方，形成了叫做<strong>死锁</strong>的状态。Go 运行时会检查并 <code>panic()</code>，停止程序。死锁几乎完全是由糟糕的设计导致的。</p><p>无缓冲通道会被阻塞。设计无阻塞的程序可以避免这种情况，或者使用带缓冲的通道。</p><p>练习 14.2： <a href="exercises/chapter_14/blocking.go">blocking.go</a></p><p>解释为什么下边这个程序会导致 panic：所有的协程都休眠了 - 死锁！</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">&quot;fmt&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">f1</span><span class="token punctuation">(</span>in <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>in<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span></span>
<span class="line">	out <span class="token operator">&lt;-</span> <span class="token number">2</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token function">f1</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_14-2-5-同步通道-使用带缓冲的通道" tabindex="-1"><a class="header-anchor" href="#_14-2-5-同步通道-使用带缓冲的通道"><span>14.2.5 同步通道-使用带缓冲的通道</span></a></h2><p>一个无缓冲通道只能包含 1 个元素，有时显得很局限。我们给通道提供了一个缓存，可以在扩展的 <code>make</code> 命令中设置它的容量，如下：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line">buf <span class="token operator">:=</span> <span class="token number">100</span></span>
<span class="line">ch1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>buf</code> 是通道可以同时容纳的元素（这里是 <code>string</code>）个数</p><p>在缓冲满载（缓冲被全部使用）之前，给一个带缓冲的通道发送数据是不会阻塞的，而从通道读取数据也不会阻塞，直到缓冲空了。</p><p>缓冲容量和类型无关，所以可以（尽管可能导致危险）给一些通道设置不同的容量，只要他们拥有同样的元素类型。内置的 <code>cap()</code> 函数可以返回缓冲区的容量。</p><p>如果容量大于 0，通道就是异步的了：缓冲满载（发送）或变空（接收）之前通信不会阻塞，元素会按照发送的顺序被接收。如果容量是 0 或者未设置，通信仅在收发双方准备好的情况下才可以成功。</p><p>同步：<code>ch :=make(chan type, value)</code></p><ul><li><code>value == 0 -&gt; synchronous</code>, unbuffered （阻塞）</li><li><code>value &gt; 0 -&gt; asynchronous</code>, buffered（非阻塞）取决于 <code>value</code> 元素</li></ul><p>若使用通道的缓冲，你的程序会在“请求”激增的时候表现更好：更具弹性，专业术语叫：更具有伸缩性(scalable)。在设计算法时首先考虑使用无缓冲通道，只在不确定的情况下使用缓冲。</p><p>练习 14.3：<a href="exercises/chapter_14/channel_buffer.go">channel_buffer.go</a>：给 <a href="exercises/chapter_14/channel_block3.go">channel_block3.go</a> 的通道增加缓冲并观察输出有何不同。</p><h2 id="_14-2-6-协程中用通道输出结果" tabindex="-1"><a class="header-anchor" href="#_14-2-6-协程中用通道输出结果"><span>14.2.6 协程中用通道输出结果</span></a></h2><p>为了知道计算何时完成，可以通过信道回报。在例子 <code>go sum(bigArray)</code> 中，要这样写：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line">ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">go</span> <span class="token function">sum</span><span class="token punctuation">(</span>bigArray<span class="token punctuation">,</span> ch<span class="token punctuation">)</span> <span class="token comment">// bigArray puts the calculated sum on ch</span></span>
<span class="line"><span class="token comment">// .. do something else for a while</span></span>
<span class="line">sum <span class="token operator">:=</span> <span class="token operator">&lt;-</span> ch <span class="token comment">// wait for, and retrieve the sum</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也可以使用通道来达到同步的目的，这个很有效的用法在传统计算机中称为信号量 (semaphore)。或者换个方式：通过通道发送信号告知处理已经完成（在协程中）。</p><p>在其他协程运行时让 <code>main</code> 程序无限阻塞的通常做法是在 <code>main()</code> 函数的最后放置一个 <code>select {}</code>。</p><p>也可以使用通道让 <code>main</code> 程序等待协程完成，就是所谓的信号量模式，我们会在接下来的部分讨论。</p><h2 id="_14-2-7-信号量模式" tabindex="-1"><a class="header-anchor" href="#_14-2-7-信号量模式"><span>14.2.7 信号量模式</span></a></h2><p>下边的片段阐明：协程通过在通道 <code>ch</code> 中放置一个值来处理结束的信号。<code>main()</code> 协程等待 <code>&lt;-ch</code> 直到从中获取到值。</p><p>我们期望从这个通道中获取返回的结果，像这样：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function">compute</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">	ch <span class="token operator">&lt;-</span> <span class="token function">someComputation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// when it completes, signal on the channel.</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> 	<span class="token comment">// allocate a channel.</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token function">compute</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>		<span class="token comment">// start something in a goroutines</span></span>
<span class="line">	<span class="token function">doSomethingElseForAWhile</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	result <span class="token operator">:=</span> <span class="token operator">&lt;-</span> ch</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个信号也可以是其他的，不返回结果，比如下面这个协程中的匿名函数 (lambda) 协程：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line">ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// doSomething</span></span>
<span class="line">	ch <span class="token operator">&lt;-</span> <span class="token number">1</span> <span class="token comment">// Send a signal; value does not matter</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token function">doSomethingElseForAWhile</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">&lt;-</span> ch	<span class="token comment">// Wait for goroutine to finish; discard sent value.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者等待两个协程完成，每一个都会对切片 <code>s</code> 的一部分进行排序，片段如下：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line">done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// doSort is a lambda function, so a closure which knows the channel done:</span></span>
<span class="line">doSort <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">	<span class="token function">sort</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span></span>
<span class="line">	done <span class="token operator">&lt;-</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">i <span class="token operator">:=</span> <span class="token function">pivot</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">go</span> <span class="token function">doSort</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">go</span> <span class="token function">doSort</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">&lt;-</span>done</span>
<span class="line"><span class="token operator">&lt;-</span>done</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下边的代码，用完整的信号量模式对长度为 <code>N</code> 的 <code>float64</code> 切片进行了 <code>N</code> 个 <code>doSomething()</code> 计算并同时完成，通道 <code>sem</code> 分配了相同的长度（且包含空接口类型的元素），待所有的计算都完成后，发送信号（通过放入值）。在循环中从通道 <code>sem</code> 不停的接收数据来等待所有的协程完成。</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">type</span> Empty <span class="token keyword">interface</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">var</span> empty Empty</span>
<span class="line"><span class="token operator">...</span></span>
<span class="line">data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">,</span> N<span class="token punctuation">)</span></span>
<span class="line">res <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">,</span> N<span class="token punctuation">)</span></span>
<span class="line">sem <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> Empty<span class="token punctuation">,</span> N<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">...</span></span>
<span class="line"><span class="token keyword">for</span> i<span class="token punctuation">,</span> xi <span class="token operator">:=</span> <span class="token keyword">range</span> data <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> xi <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		res<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">doSomething</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> xi<span class="token punctuation">)</span></span>
<span class="line">		sem <span class="token operator">&lt;-</span> empty</span>
<span class="line">	<span class="token punctuation">}</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> xi<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// wait for goroutines to finish</span></span>
<span class="line"><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span> <span class="token operator">&lt;-</span>sem <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意上述代码中闭合函数的用法：<code>i</code>、<code>xi</code> 都是作为参数传入闭合函数的，这一做法使得每个协程（译者注：在其启动时）获得一份 <code>i</code> 和 <code>xi</code> 的单独拷贝，从而向闭合函数内部屏蔽了外层循环中的 <code>i</code> 和 <code>xi</code> 变量；否则，<code>for</code> 循环的下一次迭代会更新所有协程中 <code>i</code> 和 <code>xi</code> 的值。另一方面，切片 <code>res</code> 没有传入闭合函数，因为协程不需要 <code>res</code> 的单独拷贝。切片 <code>res</code> 也在闭合函数中但并不是参数。</p><h2 id="_14-2-8-实现并行的-for-循环" tabindex="-1"><a class="header-anchor" href="#_14-2-8-实现并行的-for-循环"><span>14.2.8 实现并行的 <code>for</code> 循环</span></a></h2><p>在上一部分章节 <a class="route-link" href="/chapter-3/14.2.html#1427-%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%A8%A1%E5%BC%8F">14.2.7</a> 的代码片段中：<code>for</code> 循环的每一个迭代是并行完成的：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> data <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> v <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token function">doSomething</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span></span>
<span class="line">		<span class="token operator">...</span></span>
<span class="line">	<span class="token punctuation">}</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>for</code> 循环中并行计算迭代可能带来很好的性能提升。不过所有的迭代都必须是独立完成的。有些语言比如 Fortress 或者其他并行框架以不同的结构实现了这种方式，在 Go 中用协程实现起来非常容易：</p><h2 id="_14-2-9-用带缓冲通道实现一个信号量" tabindex="-1"><a class="header-anchor" href="#_14-2-9-用带缓冲通道实现一个信号量"><span>14.2.9 用带缓冲通道实现一个信号量</span></a></h2><p>信号量是实现互斥锁（排外锁）常见的同步机制，限制对资源的访问，解决读写问题，比如没有实现信号量的 <code>sync</code> 的 Go 包，使用带缓冲的通道可以轻松实现：</p><ul><li>带缓冲通道的容量和要同步的资源容量相同</li><li>通道的长度（当前存放的元素个数）与当前资源被使用的数量相同</li><li>容量减去通道的长度就是未处理的资源个数（标准信号量的整数值）</li></ul><p>不用管通道中存放的是什么，只关注长度；因此我们创建了一个长度可变但容量为 0（字节）的通道：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">type</span> Empty <span class="token keyword">interface</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">type</span> semaphore <span class="token keyword">chan</span> Empty</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>将可用资源的数量 <code>N</code> 来初始化信号量 <code>semaphore</code>：<code>sem = make(semaphore, N)</code></p><p>然后直接对信号量进行操作：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// acquire n resources</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">P</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	e <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Empty<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">		s <span class="token operator">&lt;-</span> e</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// release n resources</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">V</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> i<span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">{</span></span>
<span class="line">		<span class="token operator">&lt;-</span> s</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以用来实现一个互斥的例子：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">/* mutexes */</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	s<span class="token punctuation">.</span><span class="token function">P</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">	s<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">/* signal-wait */</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">Wait</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	s<span class="token punctuation">.</span><span class="token function">P</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	s<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>练习 14.5：<a href="exercises/chapter_14/gosum.go">gosum.go</a>：用这种习惯用法写一个程序，开启一个协程来计算 2 个整数的和并等待计算结果并打印出来。</p><p>练习 14.6：<a href="exercises/chapter_14/producer_consumer.go">producer_consumer.go</a>：用这种习惯用法写一个程序，有两个协程，第一个提供数字 0，10，20，...，90 并将他们放入通道，第二个协程从通道中读取并打印。<code>main()</code> 等待两个协程完成后再结束。</p><p><strong>习惯用法：通道工厂模式</strong></p><p>编程中常见的另外一种模式如下：不将通道作为参数传递给协程，而用函数来生成一个通道并返回（工厂角色）；函数内有个匿名函数被协程调用。</p><p>在 <a href="examples/chapter_14/channel_block2.go">channel_block2.go</a> 加入这种模式便有了示例 14.5-<a href="examples/chapter_14/channel_idiom.go">channel_idiom.go</a>：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">&quot;fmt&quot;</span></span>
<span class="line">	<span class="token string">&quot;time&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	stream <span class="token operator">:=</span> <span class="token function">pump</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token function">suck</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span></span>
<span class="line">	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">pump</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span></span>
<span class="line">	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">			ch <span class="token operator">&lt;-</span> i</span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">return</span> ch</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">suck</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_14-2-10-给通道使用-for-循环" tabindex="-1"><a class="header-anchor" href="#_14-2-10-给通道使用-for-循环"><span>14.2.10 给通道使用 for 循环</span></a></h2><p><code>for</code> 循环的 <code>range</code> 语句可以用在通道 <code>ch</code> 上，便可以从通道中获取值，像这样：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span></span>
<span class="line">	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The value is %v\n&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它从指定通道中读取数据直到通道关闭，才继续执行下边的代码。很明显，另外一个协程必须写入 <code>ch</code>（不然代码就阻塞在 <code>for</code> 循环了），而且必须在写入完成后才关闭。<code>suck()</code> 函数可以这样写，且在协程中调用这个动作，程序变成了这样：</p><p>示例 14.6-<a href="examples/chapter_14/channel_idiom2.go">channel_idiom2.go</a>：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">&quot;fmt&quot;</span></span>
<span class="line">	<span class="token string">&quot;time&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token function">suck</span><span class="token punctuation">(</span><span class="token function">pump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">pump</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span></span>
<span class="line">	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">			ch <span class="token operator">&lt;-</span> i</span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">return</span> ch</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">suck</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span></span>
<span class="line">			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>习惯用法：通道迭代器模式</strong></p><p>这个模式用到了后边 <a class="route-link" href="/chapter-3/14.6.html">14.6 章</a>示例 <a href="exercises/chapter_14/producer_consumer.go">producer_consumer.go</a> 的生产者-消费者模式。通常，需要从包含了地址索引字段 <code>items</code> 的容器给通道填入元素。为容器的类型定义一个方法 <code>Iter()</code>，返回一个只读的通道（参见第 <a class="route-link" href="/chapter-3/14.2.html#14211-%E9%80%9A%E9%81%93%E7%9A%84%E6%96%B9%E5%90%91">14.2.11</a> 节）<code>items</code>，如下：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>container<span class="token punctuation">)</span> Iter <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span> <span class="token keyword">chan</span> item <span class="token punctuation">{</span></span>
<span class="line">	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> item<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">for</span> i<span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> c<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">{</span>	<span class="token comment">// or use a for-range loop</span></span>
<span class="line">			ch <span class="token operator">&lt;-</span> c<span class="token punctuation">.</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">return</span> ch</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在协程里，一个 <code>for</code> 循环迭代容器 <code>c</code> 中的元素（对于树或图的算法，这种简单的 <code>for</code> 循环可以替换为深度优先搜索）。</p><p>调用这个方法的代码可以这样迭代容器：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">for</span> x <span class="token operator">:=</span> <span class="token keyword">range</span> container<span class="token punctuation">.</span><span class="token function">Iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>其运行在自己启动的协程中，所以上边的迭代用到了一个通道和两个协程（可能运行在不同的线程上）。 这样我们就有了一个典型的生产者-消费者模式。如果在程序结束之前，向通道写值的协程未完成工作，则这个协程不会被垃圾回收；这是设计使然。这种看起来并不符合预期的行为正是由通道这种线程安全的通信方式所导致的。如此一来，一个协程为了写入一个永远无人读取的通道而被挂起就成了一个 bug ，而并非你预想中的那样被悄悄回收掉 (garbage-collected) 了。</p><p><strong>习惯用法：生产者消费者模式</strong></p><p>假设你有 <code>Produce()</code> 函数来产生 <code>Consume()</code> 函数需要的值。它们都可以运行在独立的协程中，生产者在通道中放入给消费者读取的值。整个处理过程可以替换为无限循环：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token function">Consume</span><span class="token punctuation">(</span><span class="token function">Produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_14-2-11-通道的方向" tabindex="-1"><a class="header-anchor" href="#_14-2-11-通道的方向"><span>14.2.11 通道的方向</span></a></h2><p>通道类型可以用注解来表示它只发送或者只接收：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">var</span> send_only <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span> 		<span class="token comment">// channel can only receive data</span></span>
<span class="line"><span class="token keyword">var</span> recv_only <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span>		<span class="token comment">// channel can only send data</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>只接收的通道 (<code>&lt;-chan T</code>) 无法关闭，因为关闭通道是发送者用来表示不再给通道发送值了，所以对只接收通道是没有意义的。通道创建的时候都是双向的，但也可以分配给有方向的通道变量，就像以下代码：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// bidirectional</span></span>
<span class="line"><span class="token keyword">go</span> <span class="token function">source</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">go</span> <span class="token function">sink</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">source</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token punctuation">{</span> ch <span class="token operator">&lt;-</span> <span class="token number">1</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">sink</span><span class="token punctuation">(</span>ch <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token punctuation">{</span> <span class="token operator">&lt;-</span>ch <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>习惯用法：管道和选择器模式</strong></p><p>更具体的例子还有协程处理它从通道接收的数据并发送给输出通道：</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line">sendChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span></span>
<span class="line">receiveChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">go</span> <span class="token function">processChannel</span><span class="token punctuation">(</span>sendChan<span class="token punctuation">,</span> receiveChan<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">processChannel</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> out <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> inValue <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span></span>
<span class="line">		result <span class="token operator">:=</span> <span class="token operator">...</span> <span class="token comment">/// processing inValue</span></span>
<span class="line">		out <span class="token operator">&lt;-</span> result</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过使用方向注解来限制协程对通道的操作。</p><p>这里有一个来自 Go 指导的很赞的例子，打印了输出的素数，使用选择器（‘筛’）作为它的算法。每个 prime 都有一个选择器，如下图：</p><p><img src="/images/14.2_fig14.2.png" alt=""></p><p>版本1：示例 14.7-<a href="examples/chapter_14/sieve1.go">sieve1.go</a></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// Copyright 2009 The Go Authors. All rights reserved.</span></span>
<span class="line"><span class="token comment">// Use of this source code is governed by a BSD-style</span></span>
<span class="line"><span class="token comment">// license that can be found in the LICENSE file.package main</span></span>
<span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Send the sequence 2, 3, 4, ... to channel &#39;ch&#39;.</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">generate</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">		ch <span class="token operator">&lt;-</span> i <span class="token comment">// Send &#39;i&#39; to channel &#39;ch&#39;.</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Copy the values from channel &#39;in&#39; to channel &#39;out&#39;,</span></span>
<span class="line"><span class="token comment">// removing those divisible by &#39;prime&#39;.</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">filter</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> out <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> prime <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">		i <span class="token operator">:=</span> <span class="token operator">&lt;-</span>in <span class="token comment">// Receive value of new variable &#39;i&#39; from &#39;in&#39;.</span></span>
<span class="line">		<span class="token keyword">if</span> i<span class="token operator">%</span>prime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">			out <span class="token operator">&lt;-</span> i <span class="token comment">// Send &#39;i&#39; to channel &#39;out&#39;.</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// The prime sieve: Daisy-chain filter processes together.</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// Create a new channel.</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token function">generate</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>      <span class="token comment">// Start generate() as a goroutine.</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">		prime <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch</span>
<span class="line">		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>prime<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span></span>
<span class="line">		ch1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token keyword">go</span> <span class="token function">filter</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> ch1<span class="token punctuation">,</span> prime<span class="token punctuation">)</span></span>
<span class="line">		ch <span class="token operator">=</span> ch1</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>协程 <code>filter(in, out chan int, prime int)</code> 拷贝整数到输出通道，丢弃掉可以被 <code>prime</code> 整除的数字。然后每个 <code>prime</code> 又开启了一个新的协程，生成器和选择器并发请求。</p><p>输出：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">2 3 5 7 11 13 17 19 23 29 31 37 41 43 47 53 59 61 67 71 73 79 83 89 97 101</span>
<span class="line">103 107 109 113 127 131 137 139 149 151 157 163 167 173 179 181 191 193 197 199 211 223</span>
<span class="line">227 229 233 239 241 251 257 263 269 271 277 281 283 293 307 311 313 317 331 337 347 349</span>
<span class="line">353 359 367 373 379 383 389 397 401 409 419 421 431 433 439 443 449 457 461 463 467 479</span>
<span class="line">487 491 499 503 509 521 523 541 547 557 563 569 571 577 587 593 599 601 607 613 617 619</span>
<span class="line">631 641 643 647 653 659 661 673 677 683 691 701 709 719 727 733 739 743 751 757 761 769</span>
<span class="line">773 787 797 809 811 821 823 827 829 839 853 857 859 863 877 881 883 887 907 911 919 929</span>
<span class="line">937 941 947 953 967 971 977 983 991 997 1009 1013...</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第二个版本引入了上边的习惯用法：函数 <code>sieve()</code>、<code>generate()</code> 和 <code>filter()</code> 都是工厂；它们创建通道并返回，而且使用了协程的 lambda 函数。<code>main()</code> 函数现在短小清晰：它调用 <code>sieve()</code> 返回了包含素数的通道，然后通过 <code>fmt.Println(&lt;-primes)</code> 打印出来。</p><p>版本2：示例 14.8-<a href="examples/chapter_14/sieve2.go">sieve2.go</a></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token comment">// Copyright 2009 The Go Authors. All rights reserved.</span></span>
<span class="line"><span class="token comment">// Use of this source code is governed by a BSD-style</span></span>
<span class="line"><span class="token comment">// license that can be found in the LICENSE file.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">&quot;fmt&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Send the sequence 2, 3, 4, ... to returned channel</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span></span>
<span class="line">	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">			ch <span class="token operator">&lt;-</span> i</span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">return</span> ch</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Filter out input values divisible by &#39;prime&#39;, send rest to returned channel</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">filter</span><span class="token punctuation">(</span>in <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> prime <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span></span>
<span class="line">	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">if</span> i <span class="token operator">:=</span> <span class="token operator">&lt;-</span>in<span class="token punctuation">;</span> i<span class="token operator">%</span>prime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">				out <span class="token operator">&lt;-</span> i</span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">return</span> out</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">sieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span></span>
<span class="line">	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		ch <span class="token operator">:=</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">			prime <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch</span>
<span class="line">			ch <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> prime<span class="token punctuation">)</span></span>
<span class="line">			out <span class="token operator">&lt;-</span> prime</span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">return</span> out</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	primes <span class="token operator">:=</span> <span class="token function">sieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>primes<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="链接" tabindex="-1"><a class="header-anchor" href="#链接"><span>链接</span></a></h2><ul><li><a class="route-link" href="/chapter-3/directory.html">目录</a></li><li>上一节：<a class="route-link" href="/chapter-3/14.1.html">并发、并行和协程</a></li><li>下一节：<a class="route-link" href="/chapter-3/14.3.html">协程同步：关闭通道-测试阻塞的通道</a></li></ul></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/chapter-3/14.1.html" aria-label="14.1 并发、并行和协程"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>14.1 并发、并行和协程</span></div></a><a class="route-link auto-link next" href="/chapter-3/14.3.html" aria-label="14.3 协程的同步：关闭通道-测试阻塞的通道"><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span>14.3 协程的同步：关闭通道-测试阻塞的通道</span></div></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DtITwm2S.js" defer></script>
  </body>
</html>
